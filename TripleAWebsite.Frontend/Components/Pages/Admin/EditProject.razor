@page "/admin/project/edit/{Id:int?}"
@using Microsoft.EntityFrameworkCore
@using TripleAWebsite.Frontend.Data
@using TripleAWebsite.Frontend.Services
@inject ApplicationDbContext DbContext
@inject FileService FileService
@inject NavigationManager Nav
@rendermode InteractiveServer

<div class="container py-5" style="max-width: 800px;">
    <div class="d-flex align-items-center mb-4">
        <a href="/admin/projects" class="btn btn-outline-secondary me-3">&larr; Back</a>
        <h2 class="fw-bold m-0">@(Id == null ? "New Project" : "Edit Project")</h2>
    </div>

    @if (Model == null)
    {
        <div class="spinner-border text-primary"></div>
    }
    else
    {
        <EditForm Model="Model" OnValidSubmit="SaveProject" FormName="ProjectForm">
            <DataAnnotationsValidator />
            <ValidationSummary class="alert alert-danger mb-3" />

            <div class="card shadow-sm p-4">
                <div class="row g-3">

                    <div class="col-md-9">
                        <label class="form-label">Project Name</label>
                        <InputText @bind-Value="Model.Name" class="form-control" placeholder="e.g. Portfolio Website" />
                        <ValidationMessage For="() => Model.Name" class="text-danger small" />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Order #</label>
                        <InputNumber @bind-Value="Model.DisplayOrder" class="form-control" />
                    </div>

                    <div class="col-12">
                        <label class="form-label">Description</label>
                        <InputTextArea @bind-Value="Model.Description" class="form-control" rows="4" placeholder="Briefly describe the tech stack and features..." />
                        <ValidationMessage For="() => Model.Description" class="text-danger small" />
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">GitHub URL</label>
                        <InputText @bind-Value="Model.GithubUrl" class="form-control" placeholder="https://github.com/..." />
                        <ValidationMessage For="() => Model.GithubUrl" class="text-danger small" />
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Live Demo URL (Optional)</label>
                        <InputText @bind-Value="Model.LiveUrl" class="form-control" placeholder="https://..." />
                        <ValidationMessage For="() => Model.LiveUrl" class="text-danger small" />
                    </div>

                    <div class="col-12">
                        <label class="form-label">Project Screenshot</label>

                        @if (!string.IsNullOrEmpty(Model.ImageUrl))
                        {
                            <div class="mb-2 p-2 border rounded bg-light">
                                <img src="@Model.ImageUrl" height="150" class="d-block mb-2 rounded shadow-sm" style="max-width: 100%; object-fit: contain;" />
                                <span class="badge bg-success">Current Image</span>
                            </div>
                        }

                        <InputFile OnChange="UploadImage" class="form-control" accept=".jpg,.png,.jpeg,.webp" />
                        <div class="form-text">Recommended size: 16:9 ratio (e.g., 1280x720).</div>
                    </div>
                </div>

                <div class="mt-4 text-end">
                    <button type="submit" class="btn btn-primary px-5 py-2 fw-bold">
                        @(Id == null ? "Create Project" : "Save Changes")
                    </button>
                </div>
            </div>
        </EditForm>
    }
</div>

@code {
    [Parameter] public int? Id { get; set; }
    private Project? Model { get; set; }

    protected override async Task OnInitializedAsync()
    {
        if (Id != null)
        {
            // Edit Mode: Fetch existing
            Model = await DbContext.Projects.FindAsync(Id);
        }
        else
        {
            // Create Mode: New instance
            Model = new Project { DisplayOrder = 1 };
        }
    }

    private async Task UploadImage(InputFileChangeEventArgs e)
    {
        // 1. Delete old image if we are replacing it
        if (!string.IsNullOrEmpty(Model!.ImageUrl))
        {
            FileService.DeleteFile(Model.ImageUrl);
        }

        // 2. Save new image using the service (generates a unique name)
        // We pass the project name to Create a friendly filename like "MyProject-screenshot.jpg"
        var friendlyName = string.IsNullOrWhiteSpace(Model.Name) ? "project-img" : $"{Model.Name.Trim()}-screenshot";

        Model.ImageUrl = await FileService.SaveFileAsync(e.File, friendlyName);
    }

    private async Task SaveProject()
    {
        if (Model!.Id == 0)
        {
            DbContext.Projects.Add(Model);
        }
        else
        {
            DbContext.Projects.Update(Model);
        }

        await DbContext.SaveChangesAsync();
        Nav.NavigateTo("/admin/projects");
    }
}
